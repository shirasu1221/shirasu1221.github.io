<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SQLite Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.min.js"></script>
</head>
<body>
    <h2>Block Blast スコア編集ツール</h2>
    
    <input type="file" id="fileInput">
    <br><br>
    
    <button id="saveBtn" disabled>編集して保存（ダウンロード）</button>

    <div id="output" style="margin-top:20px;"></div>

    <script>
        // ここにJavaScriptの命令を書きます
        let db = null;
        const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` };

        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            const SQL = await initSqlJs(config);
            const arrayBuffer = await file.arrayBuffer();
            db = new SQL.Database(new Uint8Array(arrayBuffer));
            
            // 読み込めたら保存ボタンを押せるようにする
            document.getElementById('saveBtn').disabled = false;
            alert("ファイルが読み込まれました。これから自動でスコアを999999に書き換えます。");
        };

        document.getElementById('saveBtn').onclick = () => {
            // スコアが含まれるJSONデータを強制的に書き換える命令
            const newScoreData = JSON.stringify({
                "comboMaxNum": 999,
                "eliminateAll": 999,
                "highScore": 999999,
                "clearNum": 999
            });

            // SQLでデータベースを更新
            db.run("UPDATE kv SET value = ? WHERE key = 'block-blast-classDataStatisticsInfo'", [newScoreData]);

            // 書き換えたデータをファイルとして出力
            const data = db.export();
            const blob = new Blob([data], { type: 'application/octet-stream' });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = 'jsb.sqlite'; // 名前を同じにしてダウンロード
            a.click();
            alert("保存しました！このファイルをEsignで上書きしてください。");
        };
    </script>
</body>
</html>
