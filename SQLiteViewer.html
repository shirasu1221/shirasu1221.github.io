<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Block Blast Score Editor</title>
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        #drop-area { border: 3px dashed #007aff; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer; background: #eef6ff; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; word-break: break-all; }
        th { background: #007aff; color: white; position: sticky; top: 0; }
        input { width: 100%; padding: 5px; border: 1px solid #007aff; border-radius: 4px; box-sizing: border-box; }
        .btn-save { display: block; width: 100%; padding: 15px; margin-top: 20px; background: #34c759; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-save:disabled { background: #ccc; }
        .search-box { margin: 15px 0; padding: 10px; width: 100%; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸš€ ã‚¹ã‚³ã‚¢ç·¨é›†ãƒ„ãƒ¼ãƒ«</h2>
    <p>1. <code>jsb.sqlite</code> ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    
    <div id="drop-area" onclick="document.getElementById('file-input').click()">
        <strong>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</strong>
        <input type="file" id="file-input" accept=".sqlite,.db" style="display:none">
    </div>

    <input type="text" id="search" class="search-box" placeholder="1776 ã¾ãŸã¯ score ã§æ¤œç´¢..." oninput="filterTable()">

    <div id="status" style="margin-top:10px; color: #666;">çŠ¶æ…‹: å¾…æ©Ÿä¸­</div>

    <div style="overflow-x:auto; max-height: 400px;">
        <div id="table-container"></div>
    </div>

    <button id="save-btn" class="btn-save" disabled>ç·¨é›†ã‚’å®Œäº†ã—ã¦ä¿å­˜(Download)</button>
</div>

<script>
    let db = null;
    const status = document.getElementById('status');

    async function init() {
        try {
            const SQL = await initSqlJs({ locateFile: file => `https://sql.js.org/dist/${file}` });
            
            document.getElementById('file-input').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                status.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
                const arrayBuffer = await file.arrayBuffer();
                db = new SQL.Database(new Uint8Array(arrayBuffer));
                
                renderTable();
                document.getElementById('save-btn').disabled = false;
                status.innerText = "èª­ã¿è¾¼ã¿å®Œäº†ã€‚æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚";
            };
        } catch (err) {
            status.innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            console.error(err);
        }
    }

    function renderTable() {
        const res = db.exec("SELECT key, value FROM kv");
        if (!res.length) return;

        const values = res[0].values;
        let html = '<table id="data-table"><thead><tr><th>Key (åå‰)</th><th>Value (æ›¸ãæ›ãˆã‚‹æ•°å­—)</th></tr></thead><tbody>';

        values.forEach((row) => {
            // valueãŒJSONå½¢å¼ã®å ´åˆãŒã‚ã‚‹ãŸã‚ã€ç·¨é›†ã—ã‚„ã™ã„ã‚ˆã†ã«å‡¦ç†
            html += `<tr>
                <td>${row[0]}</td>
                <td><input type="text" value='${row[1]}' data-key="${row[0]}" onchange="updateDB(this)"></td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('table-container').innerHTML = html;
    }

    function updateDB(input) {
        const key = input.getAttribute('data-key');
        const val = input.value;
        const stmt = db.prepare("UPDATE kv SET value = ? WHERE key = ?");
        stmt.run([val, key]);
        stmt.free();
        status.innerText = "ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸã€‚æœ€å¾Œã«ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
    }

    function filterTable() {
        const q = document.getElementById('search').value.toLowerCase();
        const rows = document.querySelectorAll('#data-table tbody tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(q) ? '' : 'none';
        });
    }

    document.getElementById('save-btn').onclick = () => {
        const data = db.export();
        const blob = new Blob([data], { type: "application/octet-stream" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "jsb.sqlite";
        a.click();
        status.innerText = "ä¿å­˜ã—ã¾ã—ãŸï¼Esignã§ä¸Šæ›¸ãã—ã¦ãã ã•ã„ã€‚";
    };

    init();
</script>
</body>
</html>
